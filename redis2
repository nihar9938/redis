#!/usr/bin/env python3
import os
import urllib.request
import urllib.parse
import urllib.error
import tarfile
import sys

# ðŸ”— UPDATE THIS URL TO YOUR ACTUAL GNS REDIS URL (should end with .tar.gz)
REDIS_URL = "http://gns.site.gs.com/path/gns/area/certified/external/redis/io/redisbinary/redis-6.2.2_fixed-6.2.2_fixed/deployable.tar.gz"
OUTPUT_FILE = 'deployable.tar.gz'  # Updated to deployable.tar.gz

# ðŸ” ID/PASSWORD AUTHENTICATION (UPDATE THESE)
USERNAME = "your_username"  # Replace with your username
PASSWORD = "your_password"  # Replace with your password

def download_redis():
    """Download Redis binaries from GNS web interface with ID/Password auth - RUNS ONCE"""
    print(f"ðŸ“¥ Downloading Redis from: {REDIS_URL}")
    
    # Check if credentials are provided
    if not USERNAME or not PASSWORD:
        print("âŒ ERROR: USERNAME and PASSWORD must be set")
        sys.exit(1)
    
    try:
        # ðŸ” Create password manager and authentication handler
        password_mgr = urllib.request.HTTPPasswordMgrWithDefaultRealm()
        password_mgr.add_password(None, REDIS_URL, USERNAME, PASSWORD)
        
        # Create authentication handler
        auth_handler = urllib.request.HTTPBasicAuthHandler(password_mgr)
        
        # Create opener with authentication
        opener = urllib.request.build_opener(auth_handler)
        
        # Install the opener globally
        urllib.request.install_opener(opener)
        
        # Download the file
        print("ðŸ” Authenticating with username/password...")
        request = urllib.request.Request(REDIS_URL)
        response = urllib.request.urlopen(request)
        
        with open(OUTPUT_FILE, 'wb') as writer:
            writer.write(response.read())
        print(f"âœ… Downloaded to {OUTPUT_FILE}")
        
        # Extract TAR.GZ file
        extract_tar_gz(OUTPUT_FILE)
            
    except urllib.error.HTTPError as e:
        print(f"âŒ HTTP Error: {e.code} - {e.reason}")
        if e.code == 401:
            print("âš ï¸ Authentication failed - check your username/password")
        elif e.code == 403:
            print("âš ï¸ Access forbidden - check your permissions")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ Error downloading Redis: {e}")
        sys.exit(1)

def extract_tar_gz(filename):
    """Extract TAR.GZ file"""
    print(f"ðŸ“¦ Extracting {filename}...")
    with tarfile.open(filename, 'r:gz') as tar_ref:
        tar_ref.extractall('.')
    print(f"âœ… Extracted {filename}")

def copy_binaries_to_build_context():
    """Copy Redis binaries from extracted directory to build context"""
    print("ðŸ“‹ Copying Redis binaries to build context...")
    
    # Find the extracted Redis directory
    # Since the file is deployable.tar.gz, look for the actual Redis binaries
    redis_dirs = [d for d in os.listdir('.') if os.path.isdir(d) and 'redis' in d.lower()]
    
    if not redis_dirs:
        print("âŒ ERROR: Cannot find Redis directory after extraction")
        print("ðŸ“‹ Directories after extraction:")
        for d in os.listdir('.'):
            print(f"   - {d}")
        
        # Look for redis-server in any subdirectory
        for root, dirs, files in os.walk('.'):
            if 'redis-server' in files:
                print(f"âœ… Found redis-server in: {root}")
                # Copy from this directory
                import shutil
                shutil.copy2(os.path.join(root, "redis-server"), ".")
                shutil.copy2(os.path.join(root, "redis-cli"), ".")
                shutil.copy2(os.path.join(root, "redis-benchmark"), ".")
                shutil.copy2(os.path.join(root, "redis-check-aof"), ".")
                shutil.copy2(os.path.join(root, "redis-check-rdb"), ".")
                
                # Make executable
                os.chmod("redis-server", 0o755)
                os.chmod("redis-cli", 0o755)
                os.chmod("redis-benchmark", 0o755)
                os.chmod("redis-check-aof", 0o755)
                os.chmod("redis-check-rdb", 0o755)
                
                print("âœ… Redis binaries copied to build context")
                return
        
        print("âŒ ERROR: Cannot find Redis binaries in extracted files")
        sys.exit(1)
    
    redis_dir = redis_dirs[0]  # Take the first redis directory
    print(f"âœ… Found Redis directory: {redis_dir}")
    
    # Copy binaries to current directory (build context)
    import shutil
    shutil.copy2(os.path.join(redis_dir, "redis-server"), ".")
    shutil.copy2(os.path.join(redis_dir, "redis-cli"), ".")
    shutil.copy2(os.path.join(redis_dir, "redis-benchmark"), ".")
    shutil.copy2(os.path.join(redis_dir, "redis-check-aof"), ".")
    shutil.copy2(os.path.join(redis_dir, "redis-check-rdb"), ".")
    
    # Make executable
    os.chmod("redis-server", 0o755)
    os.chmod("redis-cli", 0o755)
    os.chmod("redis-benchmark", 0o755)
    os.chmod("redis-check-aof", 0o755)
    os.chmod("redis-check-rdb", 0o755)
    
    print("âœ… Redis binaries copied to build context")

def main():
    """Main function - RUNS ONCE DURING BUILD"""
    if not os.path.exists('redis-server') or not os.path.exists('redis-cli'):  # Check if binaries exist
        print("ðŸ”„ Retrieving Redis from GNS deployable.tar.gz with ID/Password authentication")
        download_redis()
        copy_binaries_to_build_context()  # Copy after download and extract
    else:
        print("âœ… Redis binaries already exist in build context")

if __name__ == '__main__':
    main()




#!/bin/bash
set -e

echo "ðŸ“ Current directory: $(pwd)"
echo "ðŸ“‹ Files in current directory:"
ls -la

# ðŸ” SET YOUR CREDENTIALS HERE (or export them)
export REDIS_USERNAME="${REDIS_USERNAME:-your_username}"  # Replace with your username
export REDIS_PASSWORD="${REDIS_PASSWORD:-your_password}"  # Replace with your password

# Update the credentials in the Python script
sed -i "s|USERNAME = \"your_username\"|USERNAME = \"$REDIS_USERNAME\"|" download_redis.py
sed -i "s|PASSWORD = \"your_password\"|PASSWORD = \"$REDIS_PASSWORD\"|" download_redis.py

# Update the URL and output file in the Python script
sed -i "s|deployable.tar.gz|deployable.tar.gz|g" download_redis.py

echo "ðŸ“¦ Downloading Redis binaries from GNS deployable.tar.gz using ID/Password authentication..."

# ðŸ” RUN PYTHON SCRIPT - DOWNLOADS ONCE WITH ID/PASSWORD
python3 download_redis.py

echo "âœ… Redis binaries downloaded and copied to build context"
echo "ðŸ“ Current directory after download:"
ls -la redis-*
----------------------
# Load prod rhel8 python image, copy source code into /apps
FROM gitlab.registry.docker.site.gs.com:443/dx/py-eng/python-images/python3.7-rhel8-prod:current

EXPOSE 2395

# Turns off writing .pyc files; superfluous on an ephemeral container.
ENV PYTHONdontwritebytecode=1

ARG system_account_id=$system_account_id
ENV system_account_id=$system_account_id

# Install system packages
RUN gs-yum-enable -e aws \
    && microdnf install vi vim htop \
    && mkdir -p /home/ \
    && mkdir -p /home/apps/ \
    && mkdir -p /home/apps/logs \
    && microdnf install \
        bash \
        bind-utils \
        bzip2 \
        curl \
        wget \
        tar

# ðŸ‘‡ DOWNLOAD REDIS FROM GNS WEB INTERFACE WITH AUTHENTICATION
RUN mkdir -p /tmp/redis-download && \
    cd /tmp/redis-download && \
    # ðŸ”— UPDATE THIS URL TO YOUR GNS WEB INTERFACE URL
    # ðŸ” UPDATE USERNAME AND PASSWORD
    wget --user=your_username --password=your_password \
         --header="Accept: application/octet-stream" \
         -O deployable.tar.gz "http://gns.site.gs.com/path/to/your/redis/deployable.tar.gz" && \
    # Extract the tar.gz file
    tar -xzf deployable.tar.gz && \
    # Find and copy Redis binaries (adjust path based on actual package structure)
    # If the structure is: deployable/redis-6.2.2-fixed/bin/redis-server
    # Or: deployable/bin/redis-server
    # Or: redis-server directly in the archive
    find . -name "redis-server" -exec cp {} /usr/local/bin/ \; && \
    find . -name "redis-cli" -exec cp {} /usr/local/bin/ \; && \
    find . -name "redis-benchmark" -exec cp {} /usr/local/bin/ \; && \
    find . -name "redis-check-aof" -exec cp {} /usr/local/bin/ \; && \
    find . -name "redis-check-rdb" -exec cp {} /usr/local/bin/ \; && \
    # Set 755 permissions
    chmod 755 /usr/local/bin/redis-* && \
    cd / && \
    rm -rf /tmp/redis-download

# Install all required packages
COPY apps/ /home/
RUN chown -R $system_account_id:$system_account_id /home/

WORKDIR /home/

# Create virtual environment
RUN python3 -m venv venv \
    && source venv/bin/activate \
    && pip3 config set global.index-url https://pypi.site.gs.com/repository/pypi-group/simple \
    && pip3 config set global.cert /etc/ssl/certs/ca-bundle.crt \
    && pip3 install -U pip \
    && pip3 install datetime \
    && pip3 install schedule \
    && pip3 install --no-cache-dir -r requirements.txt \
    && pip3 freeze

# Add the venv to PATH
ENV PATH="/home/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Make requests use GS certificates
ENV REQUESTS_CA_BUNDLE="/etc/ssl/certs/ca-bundle.crt"
ENV CA_CERT_PATH="/etc/pki/tls/certs/gs-chains.pem"

# Create Redis config file
RUN echo "bind 127.0.0.1" > /etc/redis.conf && \
    echo "port 6379" >> /etc/redis.conf && \
    echo "protected-mode no" >> /etc/redis.conf && \
    echo "maxmemory 512mb" >> /etc/redis.conf && \
    echo "maxmemory-policy allkeys-lru" >> /etc/redis.conf && \
    echo "appendonly yes" >> /etc/redis.conf && \
    echo "appendfsync everysec" >> /etc/redis.conf && \
    echo "save \"\"" >> /etc/redis.conf && \
    echo "stop-writes-on-bgsave-error no" >> /etc/redis.conf && \
    echo "dir /tmp" >> /etc/redis.conf && \
    echo "logfile /tmp/redis.log" >> /etc/redis.conf

# Default command is FastAPI (for backward compatibility)
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "2395"]
