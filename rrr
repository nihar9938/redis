#!/bin/bash
set -e

# 🔥 Get the directory where this script is located
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"

echo "📦 Current script directory: $DIR"

# 🔧 Set GNS Redis path relative to script location (or use absolute path)
GNS_REDIS_PATH="/gns/area/certified/external/redis/io/redisbinary/redis-6.2.2_fixed-6.2.2_fixed/redis-6.2.2_fixed"

# 🔧 Set target directory (where to copy binaries) - use current directory
TARGET_DIR="$DIR"  # Copy to same directory as script

echo "📍 GNS Redis Path: $GNS_REDIS_PATH"
echo "📍 Target Directory: $TARGET_DIR"

# 🔍 Verify GNS binaries exist
if [ ! -f "$GNS_REDIS_PATH/redis-server" ]; then
    echo "❌ ERROR: GNS Redis binaries not found at $GNS_REDIS_PATH"
    echo "❌ Available in parent directory:"
    ls -la $(dirname $GNS_REDIS_PATH) || true
    exit 1
fi

echo "✅ Found GNS Redis binaries"

# 📦 Copy Redis binaries to target directory
cp $GNS_REDIS_PATH/redis-server $TARGET_DIR/
cp $GNS_REDIS_PATH/redis-cli $TARGET_DIR/
cp $GNS_REDIS_PATH/redis-benchmark $TARGET_DIR/
cp $GNS_REDIS_PATH/redis-check-aof $TARGET_DIR/
cp $GNS_REDIS_PATH/redis-check-rdb $TARGET_DIR/

# 🧪 Verify and set permissions
chmod +x $TARGET_DIR/redis-server
chmod +x $TARGET_DIR/redis-cli
chmod +x $TARGET_DIR/redis-benchmark
chmod +x $TARGET_DIR/redis-check-aof
chmod +x $TARGET_DIR/redis-check-rdb

# 📋 List copied files
echo "✅ Redis binaries copied successfully to: $TARGET_DIR"
ls -la $TARGET_DIR/redis-*
task copyRedisBinaries(type: Exec) {
    description 'Copy GNS Redis binaries to project root'
    commandLine 'bash', './copy_redis_binaries.sh'
}

# 👇👇👇 Copy Redis binaries (copied by Gradle)
COPY redis-server /usr/local/bin/redis-server
COPY redis-cli /usr/local/bin/redis-cli
COPY redis-benchmark /usr/local/bin/redis-benchmark
COPY redis-check-aof /usr/local/bin/redis-check-aof
COPY redis-check-rdb /usr/local/bin/redis-check-rdb

RUN chmod +x /usr/local/bin/redis-*

# Create Redis config file
RUN echo "bind 127.0.0.1" > /etc/redis.conf && \
    echo "port 6379" >> /etc/redis.conf && \
    echo "protected-mode no" >> /etc/redis.conf && \
    echo "maxmemory 512mb" >> /etc/redis.conf && \
    echo "maxmemory-policy allkeys-lru" >> /etc/redis.conf && \
    echo "save \"\"" >> /etc/redis.conf && \
    echo "stop-writes-on-bgsave-error no" >> /etc/redis.conf && \
    echo "dir /tmp" >> /etc/redis.conf && \
    echo "logfile /tmp/redis.log" >> /etc/redis.conf


