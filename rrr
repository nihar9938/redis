#!/bin/bash
set -e

echo "📦 Copying GNS Redis binaries..."

# 🔍 Use same pattern as create_venv.sh
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null && pwd)"
echo "📍 Current directory: $DIR"

# 🔍 Search for Redis binaries in common GNS locations
REDIS_PATHS=(
    "/gns/area/certified/external/redis/io/redisbinary/redis-6.2.2_fixed-6.2.2_fixed/redis-6.2.2_fixed"
    "/gns/area/certified/com/gs/platform/redis/redis-6.2.2_fixed"
    "/gns/area/certified/io/redis/redis-6.2.2_fixed"
    "/gns/mw/redis/redis-6.2.2_fixed"
)

FOUND_PATH=""

for path in "${REDIS_PATHS[@]}"; do
    if [ -f "$path/redis-server" ]; then
        FOUND_PATH="$path"
        echo "✅ Found Redis binaries at: $path"
        break
    fi
done

if [ -z "$FOUND_PATH" ]; then
    echo "❌ ERROR: Redis binaries not found in any GNS path"
    echo "❌ Searched paths:"
    for path in "${REDIS_PATHS[@]}"; do
        echo "   - $path"
    done
    exit 1
fi

# Copy binaries
cp "$FOUND_PATH/redis-server" .
cp "$FOUND_PATH/redis-cli" .
cp "$FOUND_PATH/redis-benchmark" .
cp "$FOUND_PATH/redis-check-aof" .
cp "$FOUND_PATH/redis-check-rdb" .

chmod +x redis-server redis-cli redis-benchmark redis-check-aof redis-check-rdb

echo "✅ Copied Redis binaries"
echo "📋 Files:"
ls -la redis-*

task copyRedisBinaries(type: Exec) {
    description 'Copy GNS Redis binaries to project root'
    commandLine 'bash', './copy_redis_binaries.sh'
}

# 👇👇👇 Copy Redis binaries (copied by Gradle)
COPY redis-server /usr/local/bin/redis-server
COPY redis-cli /usr/local/bin/redis-cli
COPY redis-benchmark /usr/local/bin/redis-benchmark
COPY redis-check-aof /usr/local/bin/redis-check-aof
COPY redis-check-rdb /usr/local/bin/redis-check-rdb

RUN chmod +x /usr/local/bin/redis-*

# Create Redis config file
RUN echo "bind 127.0.0.1" > /etc/redis.conf && \
    echo "port 6379" >> /etc/redis.conf && \
    echo "protected-mode no" >> /etc/redis.conf && \
    echo "maxmemory 512mb" >> /etc/redis.conf && \
    echo "maxmemory-policy allkeys-lru" >> /etc/redis.conf && \
    echo "save \"\"" >> /etc/redis.conf && \
    echo "stop-writes-on-bgsave-error no" >> /etc/redis.conf && \
    echo "dir /tmp" >> /etc/redis.conf && \
    echo "logfile /tmp/redis.log" >> /etc/redis.conf


